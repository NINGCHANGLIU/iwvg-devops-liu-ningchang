name: CI

on:
  push:
    branches: [ develop, master ]
  pull_request:
    branches: [ develop ]

jobs:
  build:
    name: Test & SonarCloud
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      # 1) Print effective-pom to confirm JaCoCo plugin config
      - name: Diagnose JaCoCo config (effective-pom)
        run: |
          mvn -B -q help:effective-pom -Doutput=effective-pom.xml
          echo "== jacoco plugin in effective-pom (grep) =="
          grep -n "jacoco-maven-plugin" -n effective-pom.xml | head -n 50 || true

      # 2) Run verify (templates often bind jacoco prepare-agent to verify)
      - name: Build & Test (verify)
        run: |
          mvn -B clean verify

          echo "== find jacoco artifacts after verify =="
          find target -maxdepth 6 -type f \( -name "jacoco*.exec" -o -name "jacoco*.xml" \) -print || true
          find target -maxdepth 6 -type d -name "site" -print || true
          ls -la target || true

      # 3) Force JaCoCo XML generation to standard path Sonar expects
      - name: Force JaCoCo XML report (standard path)
        run: |
          mvn -B jacoco:report \
            -Djacoco.dataFile=target/jacoco.exec \
            -Djacoco.outputDirectory=target/site/jacoco

          echo "== target/site/jacoco listing =="
          ls -la target/site/jacoco || true
          ls -la target/site/jacoco/jacoco.xml || true

          echo "== jacoco LINE covered summary (first 40 counters) =="
          grep -n "<counter type=\"LINE\"" target/site/jacoco/jacoco.xml | head -n 40 || true

          echo "== Fraction in jacoco.xml (grep, may be misleading if single-line XML) =="
          grep -n "sourcefilename=\"Fraction.java\"" target/site/jacoco/jacoco.xml | head -n 5 || true

          echo "== Extract Fraction coverage from jacoco.xml (python -c) =="
          python3 -c 'import re; from pathlib import Path; xml=Path("target/site/jacoco/jacoco.xml").read_text(encoding="utf-8",errors="ignore"); \
          print("Contains Fraction.java? ->", "Fraction.java" in xml); \
          m=re.search(r"(<class name=\\"[^\\"]*Fraction[^\\"]*\\" sourcefilename=\\"Fraction\\.java\\">.*?</class>)", xml); \
          print("Fraction <class> block found? ->", bool(m)); \
          classes=re.findall(r"<class name=\\"([^\\"]*Fraction[^\\"]*)\\"", xml); \
          print("Class names containing Fraction (first 20):", classes[:20]); \
          block=(m.group(1) if m else ""); \
          line_counters=(re.findall(r"<counter type=\\"LINE\\" missed=\\"(\\d+)\\" covered=\\"(\\d+)\\\"/>", block) if m else []); \
          print("LINE counters in Fraction block (missed, covered):", line_counters[:20]); \
          print("--- Fraction block (first 800 chars) ---"); \
          print(block[:800]); \
          print("--- end ---");'

      # 4) SonarCloud analysis reads JaCoCo XML
      - name: SonarCloud analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mvn -B sonar:sonar \
            -Dsonar.projectKey=NINGCHANGLIU_iwvg-devops-liu-ningchang \
            -Dsonar.organization=ningchangliu \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
